<!-- Code is long and will be split across multiple replies due to length limits -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .circle-btn {
      margin: 5px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 1rem;
      padding: 0;
    }
    #timerDisplay { font-size: 2rem; font-weight: bold; }
    .stat-btn { margin: 5px; }
    .sub-in { background-color: #28a745 !important; }
    .sub-out { background-color: #dc3545 !important; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Game Manager</h2>

    <div class="text-center mb-3">
      <div id="timerDisplay">18:00</div>
      <div class="btn-group my-2">
        <button class="btn btn-secondary" onclick="adjustTime(-1)">−</button>
        <button class="btn btn-secondary" onclick="adjustTime(1)">+</button>
      </div>
      <div class="mb-2">
        <select id="halfSelect" class="form-select" style="max-width: 200px; margin: auto;">
          <option value="First Half">First Half</option>
          <option value="Second Half">Second Half</option>
        </select>
      </div>
      <div class="btn-group">
        <button id="startBtn" class="btn btn-success">Start</button>
        <button id="stopBtn" class="btn btn-danger">Stop</button>
      </div>
    </div>

    <h5 id="courtStatus" class="text-center mb-3">Select Starting 5</h5>

    <div id="playerButtons" class="d-flex flex-wrap justify-content-center mb-3"></div>

    <div class="text-center mb-3">
      <button id="subBtn" class="btn btn-primary">Sub</button>
    </div>

    <div id="statsSection" class="text-center mb-3" style="display: none;">
      <h5>Foul & Turnover</h5>
      <div class="btn-group mb-2">
        <button class="btn btn-warning" onclick="setStatType('Foul')">Foul</button>
        <button class="btn btn-danger" onclick="setStatType('Turnover')">Turnover</button>
      </div>
      <div id="statPlayerButtons" class="d-flex flex-wrap justify-content-center"></div>
    </div>

    <div class="text-center">
      <h5>Timeout</h5>
      <button class="btn btn-warning m-2" onclick="logEvent('My Team', 'Timeout')">My Team</button>
      <button class="btn btn-secondary m-2" onclick="logEvent('Opponent', 'Timeout')">Opponent</button>
    </div>

    <div id="logMessage" class="text-center mt-3 text-success fw-semibold"></div>
  </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbxgYEwR_vX3EN7ch0Sr8g4qGZSl23guIT-QrWswKn90EDNaW3c6BedltZT2AF6ldiLFsg/exec';
let timeLeft = 1080;
let timer = null;
let isRunning = false;
let selectedPlayers = [];
let gameStarted = false;
let subStep = 0;
let subOutPlayer = null;
let statMode = null;

function updateTimerDisplay() {
  let min = Math.floor(timeLeft / 60);
  let sec = timeLeft % 60;
  document.getElementById("timerDisplay").textContent = `${min}:${sec < 10 ? "0" + sec : sec}`;
}

function adjustTime(delta) {
  timeLeft = Math.max(0, timeLeft + delta);
  updateTimerDisplay();
}

function togglePlayer(id) {
  const index = selectedPlayers.indexOf(id);
  const btn = document.getElementById("player-" + id);
  if (!gameStarted) {
    if (index === -1 && selectedPlayers.length < 5) {
      selectedPlayers.push(id);
      btn.classList.add("btn-success");
    } else if (index !== -1) {
      selectedPlayers.splice(index, 1);
      btn.classList.remove("btn-success");
    }
  } else if (subStep === 1) {
    subOutPlayer = id;
    btn.classList.add("sub-out");
    subStep = 2;
  } else if (subStep === 2) {
    const inIndex = selectedPlayers.indexOf(id);
    if (inIndex === -1 && subOutPlayer !== null) {
      const outIndex = selectedPlayers.indexOf(subOutPlayer);
      selectedPlayers[outIndex] = id;
      document.getElementById("player-" + subOutPlayer).classList.remove("btn-success", "sub-out");
      document.getElementById("player-" + id).classList.add("btn-success");
      logEvent("Sub", `Out: Player ${subOutPlayer}, In: Player ${id}`);
      subOutPlayer = null;
      subStep = 0;
    }
  }
}

function generatePlayers() {
  const container = document.getElementById("playerButtons");
  const statButtons = document.getElementById("statPlayerButtons");
  for (let i = 1; i <= 7; i++) {
    let btn = document.createElement("button");
    btn.id = "player-" + i;
    btn.className = "btn btn-outline-dark circle-btn";
    btn.textContent = i;
    btn.onclick = () => togglePlayer(i);
    container.appendChild(btn);

    let statBtn = document.createElement("button");
    statBtn.className = "btn btn-outline-dark circle-btn";
    statBtn.textContent = i;
    statBtn.onclick = () => {
      if (statMode && gameStarted) {
        logEvent("Player " + i, statMode);
        document.getElementById("logMessage").textContent = `Player ${i} committed a ${statMode}`;
        setTimeout(() => document.getElementById("logMessage").textContent = '', 2000);
      }
    };
    statButtons.appendChild(statBtn);
  }
}

document.getElementById("startBtn").onclick = () => {
  if (selectedPlayers.length === 5 && !gameStarted) {
    gameStarted = true;
    document.getElementById("courtStatus").textContent = "Players On Court";
    document.getElementById("statsSection").style.display = "block";
    timer = setInterval(() => {
      if (timeLeft > 0) {
        timeLeft--;
        updateTimerDisplay();
      }
    }, 1000);
  }
};

document.getElementById("stopBtn").onclick = () => {
  clearInterval(timer);
  isRunning = false;
};

document.getElementById("subBtn").onclick = () => {
  if (gameStarted) {
    subStep = 1;
  }
};

function setStatType(type) {
  statMode = type;
}

function logEvent(player, stat) {
  const payload = {
    category: "GameManager",
    player: player,
    stat: stat,
    value: 1,
    clock: document.getElementById("timerDisplay").textContent,
    half: document.getElementById("halfSelect").value
  };

  const form = new FormData();
  form.append("payload", JSON.stringify(payload));

  fetch(API, { method: "POST", body: form })
    .then(res => res.json())
    .then(() => console.log("✅ Logged:", payload))
    .catch(err => console.error("❌ Error:", err));
}

generatePlayers();
updateTimerDisplay();
</script>
</body>
</html>
