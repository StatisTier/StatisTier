<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Game Manager</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body{background:#f8f9fa;padding:20px}
  .circle-btn{margin:5px;width:60px;height:60px;border-radius:50%;font-size:.9rem;line-height:46px;padding:0}
  .player-time{font-size:.8rem;color:#555}
  .stat-count{font-size:.75rem;margin-top:4px}
  #timerDisplay{font-size:2rem;font-weight:bold}
</style>
</head>
<body>
<div class="container">
  <h2 class="text-center mb-3">Game Manager</h2>

  <!-- TIMER & HALF -->
  <div class="text-center mb-3">
    <div id="timerDisplay">18:00</div>
    <div class="btn-group my-1">
      <button class="btn btn-secondary" onclick="adjustTime(-1)">−</button>
      <button class="btn btn-secondary" onclick="adjustTime(1)">+</button>
    </div>

    <!-- Half selector -->
    <div class="btn-group mb-1" role="group">
      <button id="firstHalfBtn"  class="btn btn-primary circle-btn"        onclick="setHalf('First Half')">1st</button>
      <button id="secondHalfBtn" class="btn btn-outline-primary circle-btn" onclick="setHalf('Second Half')">2nd</button>
    </div>
    <div id="currentHalf" class="fw-semibold mb-2">First Half</div>

    <div class="btn-group">
      <button id="startBtn" class="btn btn-success">Start</button>
      <button id="stopBtn"  class="btn btn-danger">Stop</button>
    </div>
  </div>

  <h5 id="courtStatus" class="text-center mb-2">Select Starting 5</h5>

  <!-- PLAYER GRID -->
  <div id="playerButtons" class="d-flex flex-wrap justify-content-center mb-3"></div>

  <!-- SUB BUTTON -->
  <div class="text-center mb-3">
    <button id="subBtn" class="btn btn-primary">Sub</button>
  </div>

  <!-- FOUL / TURNOVER -->
  <div id="statsSection" class="text-center mb-3" style="display:none">
    <h5>Foul & Turnover</h5>
    <div class="btn-group mb-2">
      <button class="btn btn-warning" onclick="setStatType('Foul')">Foul</button>
      <button class="btn btn-danger"  onclick="setStatType('Turnover')">Turnover</button>
    </div>
    <div id="statPlayerButtons" class="d-flex flex-wrap justify-content-center"></div>
  </div>

  <!-- TIMEOUTS -->
  <div class="text-center mb-2">
    <h5>Timeout</h5>
    <button class="btn btn-warning m-1"   onclick="logEvent('My Team','Timeout')">My Team</button>
    <button class="btn btn-secondary m-1" onclick="logEvent('Opponent','Timeout')">Opponent</button>
  </div>

  <div id="logMsg" class="text-center text-success fw-semibold"></div>
</div>

<script>
/* === CONFIG === */
const API='https://script.google.com/macros/s/AKfycbxgYEwR_vX3EN7ch0Sr8g4qGZSl23guIT-QrWswKn90EDNaW3c6BedltZT2AF6ldiLFsg/exec';

/* === STATE === */
let timeLeft = 1080;           // 18:00 seconds
let timer = null;
let active    = [];            // players on court
let playerTime={},fouls={},turnovers={};
let gameStarted = false;
let subMode     = false;
let subOutPlayer= null;
let statMode    = null;
let selectedHalf= 'First Half'; // default highlighted

/* === TIMER FUNCTIONS === */
function updateClock(){
  const m=Math.floor(timeLeft/60),s=timeLeft%60;
  document.getElementById('timerDisplay').textContent=`${m}:${s<10?'0'+s:s}`;
}
function adjustTime(d){timeLeft=Math.max(0,timeLeft+d);updateClock();}

/* === HALF SELECTOR === */
function setHalf(half){
  if(gameStarted) return;                // locked once game starts
  selectedHalf = half;
  document.getElementById('firstHalfBtn').className =
    half==='First Half' ? 'btn btn-primary circle-btn' : 'btn btn-outline-primary circle-btn';
  document.getElementById('secondHalfBtn').className =
    half==='Second Half'? 'btn btn-primary circle-btn' : 'btn btn-outline-primary circle-btn';
  document.getElementById('currentHalf').textContent = half;
}

/* === PLAYER GRID === */
function togglePlayer(n){
  const btn=document.getElementById(`p${n}`);
  if(!gameStarted){   // pre-game starting five selection
      const i=active.indexOf(n);
      if(i===-1 && active.length<5){active.push(n);btn.classList.add('btn-success');}
      else if(i!==-1){active.splice(i,1);btn.classList.remove('btn-success');}
  }else if(subMode){  // in-game sub flow
      const idx=active.indexOf(n);
      if(subOutPlayer===null && idx!==-1){          // first tap → sub out
          subOutPlayer=n;btn.classList.add('btn-danger');
          logEvent(`Player ${n}`,'Sub Out');
      }else if(subOutPlayer!==null && idx===-1){    // second tap → sub in
          document.getElementById(`p${subOutPlayer}`).classList.remove('btn-danger','btn-success');
          active.splice(active.indexOf(subOutPlayer),1);
          active.push(n);
          btn.classList.add('btn-success');
          logEvent(`Player ${n}`,'Sub In');
          subOutPlayer=null;subMode=false;
      }
  }
}

/* === FOUL / TURNOVER === */
function setStatType(t){statMode=t;}
function statAction(n){
  if (!gameStarted || !statMode) return;         // must be in-game + a mode picked
  if (active.indexOf(n) === -1) return;          // ignore if player is NOT on court

  if (statMode === 'Foul')     fouls[n]++;       // update local counters
  if (statMode === 'Turnover') turnovers[n]++;

  logEvent(`Player ${n}`, statMode);             // log to sheet
  document.getElementById('logMsg').textContent =
      `${statMode} on Player ${n}`;
  setTimeout(() => document.getElementById('logMsg').textContent = '', 2000);
}

/* === LOGGING === */
function logEvent(player,stat,val=1){
  const payload={category:'GameManager',player,stat,value:val,
    clock:document.getElementById('timerDisplay').textContent,half:selectedHalf};
  const fd=new FormData();fd.append('payload',JSON.stringify(payload));
  fetch(API,{method:'POST',body:fd}).catch(console.error);
}

/* === UI GENERATION === */
function createUI(){
  const pDiv=document.getElementById('playerButtons'),
        sDiv=document.getElementById('statPlayerButtons');
  for(let i=1;i<=7;i++){
      playerTime[i]=fouls[i]=turnovers[i]=0;
      const p=document.createElement('button');
      p.id=`p${i}`;p.className='btn btn-outline-dark circle-btn';p.textContent=i;
      p.onclick=()=>togglePlayer(i);pDiv.appendChild(p);

      const sp=document.createElement('button');
      sp.className='btn btn-outline-dark circle-btn';sp.textContent=i;
      sp.onclick=()=>statAction(i);sDiv.appendChild(sp);
  }
}

/* === START / STOP === */
document.getElementById('startBtn').onclick=()=>{
  if(active.length===5&&!gameStarted){
      // log starting five
      active.forEach(p=>logEvent(`Player ${p}`,'Starting Five'));
      gameStarted=true;
      document.getElementById('courtStatus').textContent='Players On Court';
      document.getElementById('statsSection').style.display='block';
      // lock half buttons
      document.getElementById('firstHalfBtn').disabled=true;
      document.getElementById('secondHalfBtn').disabled=true;
      timer=setInterval(()=>{if(timeLeft>0){timeLeft--;updateClock();active.forEach(p=>playerTime[p]++)}},1000);
  }
};
document.getElementById('stopBtn').onclick=()=>{clearInterval(timer);isRunning=false;};
document.getElementById('subBtn').onclick=()=>{if(gameStarted)subMode=true;};

/* === INIT === */
createUI();updateClock();setHalf('First Half');
</script>
</body>
</html>
